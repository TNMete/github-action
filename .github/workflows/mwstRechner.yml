name: mwst Workflow

on: push

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Post a message in a channel
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
              text: "🚀 Pipeline wurde soeben gestartet. Pipeline: ${{github.workflow}}"
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd testing-example
          npm install

      - name: Run tests
        run: |
          cd testing-example
          npm test

      - name: coverage upload
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage

      - name: Slack Nachricht bei Erfolg
        if: ${{success()}}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
              text: "✅ Test Job erfolgreich durchgelaufen - Jetzt wird deployt"

      - name: Slack Nachricht bei  Fehlschlag
        if: ${{failure()}}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
              text: "❌ Test Job fehlgeschalgen - Bitte sofort überprüfen"
  deploy:
    runs-on: ubuntu-latest
    needs: test 

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Copy mwst file to EC2
        if: success()
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/meinKey.pem
          chmod 400 ~/.ssh/meinKey.pem
          ssh-keyscan -H ${{ secrets.EC2_IP }} >> ~/.ssh/known_hosts
          scp -i ~/.ssh/meinKey.pem testing-example/mehrwertsteuer.js ubuntu@${{ secrets.EC2_IP }}:/home/ubuntu/mehrwertsteuer.js
