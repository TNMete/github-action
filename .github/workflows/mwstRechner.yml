name: HA_27082025_workflow

on: push

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Post a message in a channel
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
              text: "🚀 Pipeline wurde soeben gestartet. Pipeline: ${{ github.workflow }}"

      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: |
          cd testing-example
          npm install

      - name: Run tests
        run: |
          cd testing-example
          npm test

      - name: coverage upload
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: testing-example/coverage

      - name: Slack Nachricht bei Erfolg
        if: ${{ success() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
              text: "✅ Test Job erfolgreich durchgelaufen - Jetzt wird deployt"

      - name: Slack Nachricht bei Fehlschlag
        if: ${{ failure() }}
        uses: slackapi/slack-github-action@v2.1.1
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
              text: "❌ Test Job fehlgeschlagen - Bitte sofort überprüfen"

  deploy:
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/meinKey.pem
          chmod 400 ~/.ssh/meinKey.pem
          for ip in ${{ secrets.EC2_IP }}; do
            ssh-keyscan -H $ip >> ~/.ssh/known_hosts
          done

      - name: Copy index.html to all EC2 instances
        run: |
          for ip in ${{ secrets.EC2_IP }}; do
            echo "Deploying index.html to $ip..."
            scp -i ~/.ssh/meinKey.pem frontend/index.html ubuntu@$ip:/home/ubuntu/index.html
            ssh -i ~/.ssh/meinKey.pem ubuntu@$ip "sudo mv /home/ubuntu/index.html /var/www/html/index.html"
          done
